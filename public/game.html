<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mouse Follower Dot</title>
    <style>
        body { margin: 0; overflow: hidden; height: 100vh; cursor: none; }
        .user-dot, .random-dot { position: absolute; width: 20px; height: 20px; background-color: red; border-radius: 50%; pointer-events: none; transform: translate(-50%, -50%); }
        .random-dot { background-color: green; }
    </style>
</head>
<body>
    <div class="user-dot"></div>
    <div class="random-dot"></div>

    <script type="module">
        if (sessionStorage.getItem('gameStarted') !== 'true') {
            window.location.href = 'index.html';
        } else {
            // Clear the flag to prevent re-entry
            sessionStorage.removeItem('gameStarted');
        }

        import { initializeFirebase } from './firebaseConfig.js';
        import { doc, setDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const { db, auth } = initializeFirebase();

        let game_type = "normal";

        const game_type_lengths = {
            "normal": 15_000, // ms
            "reverse": 15_000,
            "offset": 15_000
        }

        const userDot = document.querySelector('.user-dot');
        const randomDot = document.querySelector('.random-dot');
        const width = window.innerWidth;
        const height = window.innerHeight;

        let x = width / 2;
        let y = height / 2;
        let vx = (Math.random() - 0.5) * 2;
        let vy = (Math.random() - 0.5) * 2;
        const speeds = [3,4,5];
        const turnProbability = 0.05;
        const maxTurnAngle = Math.PI / 4;
        let currentMousemoveHandler;

        let prevMouseX = null;
        let prevMouseY = null;
        let userDotX = width/2;
        let userDotY = height/2;
        let dist = null;

        let userPositions = [];
        let followPositions = [];
        let distances = [];

        function moveUser(e) {
            userDotX = e.clientX;
            userDotY = e.clientY;
            userDot.style.left = `${userDotX}px`;
            userDot.style.top = `${userDotY}px`;
        }

        function moveUserReverseXY(e) {
            userDotX = width - e.clientX;
            userDotY = height - e.clientY;
            userDot.style.left = `${userDotX}px`;
            userDot.style.top = `${userDotY}px`;
        }

        function moveUserOffsetRadians(e) {
            const radians = Math.PI / 4;

            if (prevMouseX === null || prevMouseY === null) {
                prevMouseX = e.clientX;
                prevMouseY = e.clientY;
                userDot.style.left = `${userDotX}px`;
                userDot.style.top = `${userDotY}px`;
                return; // Don't move on the first frame
            }

            const deltaX = e.clientX - prevMouseX;
            const deltaY = e.clientY - prevMouseY;

            // Rotate the delta
            const rotatedDeltaX = deltaX * Math.cos(radians) - deltaY * Math.sin(radians);
            const rotatedDeltaY = deltaX * Math.sin(radians) + deltaY * Math.cos(radians);

            userDotX += rotatedDeltaX;
            userDotY += rotatedDeltaY;

            userDotX = Math.max(0, Math.min(width, userDotX));
            userDotY = Math.max(0, Math.min(height, userDotY));

            userDot.style.left = `${userDotX}px`;
            userDot.style.top = `${userDotY}px`;

            prevMouseX = e.clientX;
            prevMouseY = e.clientY;
        }

        function distanceToDot(){
            dist = Math.sqrt((userDotX - x) ** 2 + (userDotY - y) ** 2)
            distances.push(dist);
        }

        function calculateDistancePercentages() {
            const maxDistance = Math.max(...distances);
            const sectionSizes = {
                0: Math.round(1  * maxDistance / 15),
                1: Math.round(3  * maxDistance / 15),
                2: Math.round(7  * maxDistance / 15),
                3: Math.round(11 * maxDistance / 15),
                4: Math.round(15 * maxDistance / 15)
            };
            const sections = [0, 0, 0, 0, 0];

            distances.forEach(distance => {
                if (distance < sectionSizes[0]) {
                    sections[0]++;
                } else if (distance < sectionSizes[1]) {
                    sections[1]++;
                } else if (distance < sectionSizes[2]) {
                    sections[2]++;
                } else if (distance < sectionSizes[3]) {
                    sections[3]++;
                } else {
                    sections[4]++;
                }
            });

            const percentages = sections.map(count => (count / distances.length) * 100);
            console.log("Section Sizes:", sectionSizes);
            console.log("Distance Percentages:", percentages);
            return { sectionSizes, percentages };
        }

        function moveRandomDot() {
            if (Math.random() < turnProbability) {
                const turnAngle = (Math.random() * 2 - 1) * maxTurnAngle;
                const currentAngle = Math.atan2(vy, vx);
                const newAngle = currentAngle + turnAngle;
                const speed = speeds[Math.floor(Math.random() * speeds.length)];
                vx = Math.cos(newAngle) * speed;
                vy = Math.sin(newAngle) * speed;
            }

            x += vx;
            y += vy;
            let rando_minX = width / 8;
            let rando_maxX = width - rando_minX;
            let rando_minY = height / 12;
            let rando_maxY = height - rando_minY;
            if (x < rando_minX) { x = rando_minX; vx = -vx; } else if (x > rando_maxX) { x = rando_maxX; vx = -vx; }
            if (y < rando_minY) { y = rando_minY; vy = -vy; } else if (y > rando_maxY) { y = rando_maxY; vy = -vy; }

            randomDot.style.left = `${x}px`;
            randomDot.style.top = `${y}px`;
        }

        function setMousemoveHandler() {
            if (currentMousemoveHandler) {
                document.removeEventListener('mousemove', currentMousemoveHandler);
            }

            if (game_type === "normal") {
                currentMousemoveHandler = moveUser;
            } else if (game_type === "reverse") {
                currentMousemoveHandler = moveUserReverseXY;
            } else if (game_type === "offset") {
                currentMousemoveHandler = moveUserOffsetRadians;
            }

            document.addEventListener('mousemove', currentMousemoveHandler);
        }

        async function uploadDotData(userPositions, followPositions, distances) {
            try {
                console.log("Uploading user positions...");
                await setDoc(doc(db, "user_data", auth.currentUser.uid), {
                    positions: userPositions,
                    followPositions: followPositions,
                    distances: distances, // Include distances in the upload
                    uid: auth.currentUser.uid,
                    timestamp: Timestamp.fromDate(new Date())
                });
                console.log("User positions saved!");
            } catch (error) {
                console.error("Firestore write error:", error.message);
                console.error("Error details:", error);
            }
        }

        async function play() {
            if (game_type === "done") {
                const { sectionSizes, percentages } = calculateDistancePercentages();
                localStorage.setItem('sectionSizes', JSON.stringify(Object.values(sectionSizes)));
                localStorage.setItem('percentages', JSON.stringify(percentages));
                localStorage.setItem('distances', JSON.stringify(distances));
                await uploadDotData(userPositions, followPositions, distances);
                window.location.href = `done.html`;
                return;
            }
            moveRandomDot();
            requestAnimationFrame(play);
        }

        randomDot.style.left = `${x}px`;
        randomDot.style.top = `${y}px`;

        signInAnonymously(auth)
            .then(() => {
                console.log("User signed in anonymously");
                setInterval(() => {
                    let time = Timestamp.fromDate(new Date());
                    userPositions.push({ x: userDotX, y: userDotY, game_mode: game_type, timestamp: time });
                    followPositions.push({ x: x, y: y, game_mode: game_type, timestamp: time });
                    distanceToDot();
                }, 100);

                setMousemoveHandler();
                play();

                setTimeout(() => {
                    game_type = "reverse";
                    setMousemoveHandler();
                    console.log("Game type changed to reverse");
                }, game_type_lengths["normal"]);
                setTimeout(() => {
                    game_type = "offset";
                    setMousemoveHandler();
                    console.log("Game type changed to offset");
                }, game_type_lengths["reverse"] + game_type_lengths["normal"]);
                setTimeout(() => {
                    game_type = "done";
                    setMousemoveHandler();
                    console.log("Game type changed to done");
                }, game_type_lengths["offset"] + game_type_lengths["reverse"] + game_type_lengths["normal"]);
            })
            .catch((error) => {
                console.error("Auth Error:", error.message);
            });
    </script>
</body>
</html>