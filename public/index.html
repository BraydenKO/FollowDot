<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motor Learning Study</title>
    <style>
        /* ============================================================
           BASE STYLES
           ============================================================ */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            background-color: #f5f5f5;
            overflow-y: auto;
        }

        /* ============================================================
           CONTAINER STYLES
           ============================================================ */
        .container {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
        }
        
        .container.wide {
            max-width: 700px;
        }
        
        .container.extra-wide {
            max-width: 900px;
        }

        .hidden {
            display: none !important;
        }

        /* ============================================================
           TYPOGRAPHY
           ============================================================ */
        h1 {
            text-align: center;
            color: #333;
            margin: 0 0 25px 0;
            font-size: 1.8em;
        }
        
        h2 {
            color: #444;
            font-size: 1.3em;
            margin: 0 0 20px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .blurb {
            text-align: center;
            margin-bottom: 15px;
            color: #555;
            line-height: 1.6;
        }
        
        .blurb:last-of-type {
            margin-bottom: 25px;
        }

        .highlight-green {
            color: #16a34a;
            font-weight: 600;
        }
        
        .highlight-purple {
            color: #7c3aed;
            font-weight: 600;
        }

        .highlight-blue {
            color: #2563eb;
            font-weight: 600;
            text-transform: uppercase; /* Ensures it looks important */
        }

        /* ============================================================
           FORM ELEMENTS
           ============================================================ */
        .question {
            margin-bottom: 20px;
        }
        
        .question-label {
            font-weight: 500;
            color: #333;
            margin-bottom: 8px;
            display: block;
        }

        select, 
        input[type="number"], 
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }
        
        select:focus,
        input:focus {
            outline: none;
            border-color: #2563eb;
        }

        /* ============================================================
           HANDEDNESS QUESTIONNAIRE
           ============================================================ */
        .handedness-grid {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .handedness-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .handedness-item label {
            font-weight: 500;
            color: #374151;
            flex: 1;
        }
        
        .handedness-options {
            display: flex;
            gap: 20px;
        }
        
        .handedness-options label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-weight: normal;
        }
        
        .handedness-options input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .required-indicator {
            color: #dc2626;
            margin-left: 2px;
        }

        /* ============================================================
           BUTTONS
           ============================================================ */
        .btn {
            display: block;
            width: 100%;
            padding: 14px;
            font-size: 1.1em;
            font-weight: 500;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: #2563eb;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #1d4ed8;
        }
        
        .btn-primary:disabled {
            background-color: #93c5fd;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            margin-top: 10px;
        }
        
        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        /* ============================================================
           CONSENT FORM
           ============================================================ */
        #consent-pdf {
            width: 100%;
            height: 50vh;
            min-height: 400px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .consent-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8fafc;
            border-radius: 8px;
        }
        
        .consent-checkbox input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .consent-checkbox label {
            cursor: pointer;
            line-height: 1.5;
            color: #374151;
        }

        /* ============================================================
           REJECTION SCREEN
           ============================================================ */
        .rejection-container {
            text-align: center;
            padding: 40px 20px;
        }
        
        .rejection-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        .rejection-message {
            font-size: 1.05em;
            color: #555;
            line-height: 1.7;
            margin-bottom: 18px;
            text-align: left;
        }
        
        .rejection-note {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 15px 18px;
            margin: 20px 0;
            color: #92400e;
            font-size: 0.95em;
            line-height: 1.6;
        }

        /* ============================================================
           PROGRESS INDICATOR
           ============================================================ */
        .progress-steps {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 25px;
        }
        
        .progress-step {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #e0e0e0;
        }
        
        .progress-step.active {
            background: #2563eb;
        }
        
        .progress-step.completed {
            background: #22c55e;
        }

        /* ============================================================
           ERROR MESSAGE
           ============================================================ */
        .error-message {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }
        
        .error-message.visible {
            display: block;
        }
    </style>
</head>
<body>
    <!-- ============================================================
         STEP 1: DEMOGRAPHICS
         ============================================================ -->
    <div class="container" id="step-demographics">
        <div class="progress-steps">
            <div class="progress-step active"></div>
            <div class="progress-step"></div>
            <div class="progress-step"></div>
        </div>
        
        <h1>Motor Learning Study</h1>
        
        <div id="demographics-error" class="error-message"></div>
        
        <div class="question">
            <label class="question-label">
                1) Prolific ID <span class="required-indicator">*</span>
            </label>
            <input type="text" id="prolific-id" placeholder="Enter your Prolific ID" required>
        </div>
        
        <div class="question">
            <label class="question-label">
                2) What device are you using to control the cursor? <span class="required-indicator">*</span>
            </label>
            <select id="input-device">
                <option value="" disabled selected>Select your option</option>
                <option value="mouse">Mouse</option>
                <option value="trackpad">Trackpad</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <div class="question">
            <label class="question-label">
                3) Have you participated in this study before? <span class="required-indicator">*</span>
            </label>
            <select id="played-before">
                <option value="" disabled selected>Select your option</option>
                <option value="no">No, this is my first time</option>
                <option value="yes">Yes, I have done this before</option>
            </select>
        </div>
        
        <div class="question">
            <label class="question-label">
                4) Age <span class="required-indicator">*</span>
            </label>
            <input type="number" id="age" min="18" max="120" placeholder="Enter your age">
        </div>
        
        <div class="question">
            <label class="question-label">
                5) Gender <span class="required-indicator">*</span>
            </label>
            <select id="gender">
                <option value="" disabled selected>Select your option</option>
                <option value="male">Male</option>
                <option value="female">Female</option>
                <option value="non-binary">Non-binary</option>
                <option value="prefer-not-to-say">Prefer not to say</option>
                <option value="other">Other</option>
            </select>
        </div>
        
        <button class="btn btn-primary" id="btn-to-handedness">Continue</button>
    </div>

    <!-- ============================================================
         STEP 2: EDINBURGH HANDEDNESS INVENTORY
         ============================================================ -->
    <div class="container wide hidden" id="step-handedness">
        <div class="progress-steps">
            <div class="progress-step completed"></div>
            <div class="progress-step active"></div>
            <div class="progress-step"></div>
        </div>
        
        <h1>Handedness Questionnaire</h1>
        <p class="blurb">
            Please indicate which hand you prefer to use for each of the following activities.
            <br><strong>Select the hand you would use if you had to choose one.</strong>
        </p>
        
        <div id="handedness-error" class="error-message"></div>
        
        <div class="handedness-grid" id="handedness-questions">
            <!-- Questions will be inserted here by JavaScript -->
        </div>
        
        <button class="btn btn-primary" id="btn-to-consent">Continue</button>
        <button class="btn btn-secondary" id="btn-back-to-demographics">Back</button>
    </div>

    <!-- ============================================================
         STEP 3: CONSENT FORM
         ============================================================ -->
    <div class="container extra-wide hidden" id="step-consent">
        <div class="progress-steps">
            <div class="progress-step completed"></div>
            <div class="progress-step completed"></div>
            <div class="progress-step active"></div>
        </div>
        
        <h1>Consent Form</h1>
        
        <embed id="consent-pdf" src="consent_form.pdf#toolbar=0" type="application/pdf">
        
        <div id="consent-error" class="error-message"></div>
        
        <div class="consent-checkbox">
            <input type="checkbox" id="checkbox-age">
            <label for="checkbox-age">I am 18 years of age or older</label>
        </div>
        
        <div class="consent-checkbox">
            <input type="checkbox" id="checkbox-read">
            <label for="checkbox-read">I have read and understand the information above</label>
        </div>
        
        <div class="consent-checkbox">
            <input type="checkbox" id="checkbox-consent">
            <label for="checkbox-consent">I want to participate in this research and continue with the Motor Learning Task</label>
        </div>
        
        <button class="btn btn-primary" id="btn-start-game">Start Experiment</button>
        <button class="btn btn-secondary" id="btn-back-to-handedness">Back</button>
    </div>

    <!-- ============================================================
         STEP 4: INSTRUCTIONS (shown briefly before game)
         ============================================================ -->
    <div class="container hidden" id="step-instructions">
        <h1>Instructions</h1>
        
        <div class="blurb">
            This experiment will take approximately <strong>30 minutes</strong>.
        </div>
        
        <div class="blurb">
            Please use your <span id="instruction-hand" class="highlight-blue"></span> hand 
            to control the mouse.
        </div>

        <div class="blurb">
            You will control the fly's <span class="highlight-green">shadow</span>. 
            Your goal is to follow the moving <span class="highlight-purple">fly</span> as closely as possible.
        </div>
        
        <div class="blurb">
            You will complete a series of trials. During some trials, the way your cursor responds 
            to your movements may gradually change.
        </div>
        
        <div class="blurb">
            <strong>Try to adapt and stay as close to the fly as possible!</strong>
        </div>
        
        <button class="btn btn-primary" id="btn-begin">Begin</button>
    </div>

    <!-- ============================================================
         REJECTION SCREEN (Wrong Device)
         ============================================================ -->
    <div class="container hidden" id="step-rejected-device">
        <div class="rejection-container">
            <div class="rejection-icon">üñ±Ô∏è</div>
            <h1>Mouse Required</h1>
            
            <p class="rejection-message">
                Thank you for your interest in our study!
            </p>
            
            <p class="rejection-message">
                Unfortunately, this experiment requires the use of a <strong>computer mouse</strong> 
                to ensure accurate tracking of hand movements. Trackpads and other input devices 
                can affect the precision of our measurements.
            </p>
            
            <p class="rejection-message">
                If you have access to a mouse, you're welcome to return and participate using that device.
            </p>
            
            <div class="rejection-note">
                <strong>Note:</strong> Your response has been recorded for our records.
            </div>
            
            <p class="rejection-message">
                You may now close this window. Thank you for your understanding!
            </p>
        </div>
    </div>

    <!-- ============================================================
         REJECTION SCREEN (Handedness)
         ============================================================ -->
    <div class="container hidden" id="step-rejected">
        <div class="rejection-container">
            <div class="rejection-icon">üôè</div>
            <h1>Thank You for Your Interest</h1>
            
            <p class="rejection-message">
                We really appreciate you taking the time to complete the questionnaire!
            </p>
            
            <p class="rejection-message">
                This particular study is investigating how people with <strong>strongly dominant hand preference</strong> 
                learn new motor skills. To ensure valid results, we can only include participants who consistently 
                use the same hand for key everyday activities.
            </p>
            
            <p class="rejection-message">
                Based on your responses, your handedness pattern doesn't match our current recruitment criteria. 
                This isn't a reflection on you ‚Äî many people naturally use different hands for different tasks!
            </p>
            
            <div class="rejection-note">
                <strong>Please note:</strong> Your Prolific ID has been recorded. To maintain data integrity, 
                you will not be able to retake this screening or participate in this study.
            </div>
            
            <p class="rejection-message">
                You may now close this window. Thank you again for your interest in our research!
            </p>
        </div>
    </div>

    <!-- ============================================================
         JAVASCRIPT
         ============================================================ -->
    <script>
        // ============================================================
        // CONFIGURATION - Easy to modify study parameters
        // ============================================================
        const CONFIG = {
            // ----------------------------------------------------------
            // INPUT DEVICE FILTERING
            // ----------------------------------------------------------
            inputDevice: {
                // Only allow these devices (others will be rejected)
                allowedDevices: ['mouse']
            },
            
            // ----------------------------------------------------------
            // HANDEDNESS FILTERING
            // ----------------------------------------------------------
            handedness: {
                // Which handedness to recruit: 'right', 'left', or 'both'
                // Change this single value to switch recruitment mode
                recruitingFor: 'right',
                
                // For LEFT-HANDED recruitment: 5 critical questions (subset)
                criticalQuestionsLeft: [
                    'trackpad', 'writing', 'drawing', 'throwing', 'knife'
                ],
                
                // For RIGHT-HANDED recruitment: ALL 16 questions (stricter)
                criticalQuestionsRight: [
                    'writing', 'drawing', 'throwing', 'scissors', 'toothbrush',
                    'knife', 'spoon', 'broom', 'match', 'box', 'mouse', 'trackpad',
                    'key', 'hammer', 'brush', 'cup'
                ],

                // Keep ALL CAPS
                hand_to_use : 'RIGHT',

                direction: 'CW' // Direction of rotation in game
            },
            
            // ----------------------------------------------------------
            // FIREBASE SETTINGS
            // ----------------------------------------------------------
            firebase: {
                experimentCollection: 'experiments_v2',
                statisticsDocument: 'study_statistics',
                enabled: true
            },
            
            // ----------------------------------------------------------
            // NAVIGATION
            // ----------------------------------------------------------
            navigation: {
                gamePage: 'game.html'
            }
        };

        // ============================================================
        // COLLECTION NAME CALCULATOR
        // ============================================================
        function getCollectionName() {
            const recruit_hand = CONFIG.handedness.recruitingFor;
            const use_hand = CONFIG.handedness.hand_to_use;
            const direction = CONFIG.handedness.direction;
            const collection_name = `experiments_v2_${recruit_hand}_${use_hand}_${direction}`;

            CONFIG.firebase.experimentCollection = collection_name;
            return collection_name;
        }
        getCollectionName();


        // ============================================================
        // EDINBURGH HANDEDNESS INVENTORY QUESTIONS
        // ============================================================
        const HANDEDNESS_QUESTIONS = [
            { id: 'writing', label: 'Writing' },
            { id: 'drawing', label: 'Drawing' },
            { id: 'throwing', label: 'Throwing' },
            { id: 'scissors', label: 'Using scissors' },
            { id: 'toothbrush', label: 'Using a toothbrush' },
            { id: 'knife', label: 'Using a knife (without a fork)' },
            { id: 'spoon', label: 'Using a spoon' },
            { id: 'broom', label: 'Using a broom (upper hand)' },
            { id: 'match', label: 'Striking a match' },
            { id: 'box', label: 'Opening a box (holding the lid)' },
            { id: 'mouse', label: 'Holding a computer mouse' },
            { id: 'trackpad', label: 'Using a computer trackpad' },
            { id: 'key', label: 'Using a key to unlock a door' },
            { id: 'hammer', label: 'Holding a hammer' },
            { id: 'brush', label: 'Holding a brush or comb' },
            { id: 'cup', label: 'Holding a cup while drinking' }
        ];

        // ============================================================
        // STATE
        // ============================================================
        const state = {
            demographics: {
                prolificId: '',
                inputDevice: '',
                playedBefore: '',
                age: null,
                gender: ''
            },
            handedness: {},  // Will store answers for each question
            eligibility: {
                isEligible: false,
                dominantHand: null,
                reason: ''
            }
        };

        // Firebase references (set by module script)
        let firebaseRefs = {
            db: null,
            auth: null,
            doc: null,
            setDoc: null,
            getDoc: null,
            updateDoc: null,
            increment: null,
            Timestamp: null
        };

        // ============================================================
        // DOM ELEMENTS
        // ============================================================
        const elements = {
            // Steps
            stepDemographics: document.getElementById('step-demographics'),
            stepHandedness: document.getElementById('step-handedness'),
            stepConsent: document.getElementById('step-consent'),
            stepInstructions: document.getElementById('step-instructions'),
            stepRejected: document.getElementById('step-rejected'),
            stepRejectedDevice: document.getElementById('step-rejected-device'),
            
            // Buttons
            btnToHandedness: document.getElementById('btn-to-handedness'),
            btnToConsent: document.getElementById('btn-to-consent'),
            btnBackToDemographics: document.getElementById('btn-back-to-demographics'),
            btnBackToHandedness: document.getElementById('btn-back-to-handedness'),
            btnStartGame: document.getElementById('btn-start-game'),
            btnBegin: document.getElementById('btn-begin'),
            
            // Inputs
            prolificId: document.getElementById('prolific-id'),
            inputDevice: document.getElementById('input-device'),
            playedBefore: document.getElementById('played-before'),
            age: document.getElementById('age'),
            gender: document.getElementById('gender'),
            
            // Consent checkboxes
            checkboxAge: document.getElementById('checkbox-age'),
            checkboxRead: document.getElementById('checkbox-read'),
            checkboxConsent: document.getElementById('checkbox-consent'),
            
            // Containers
            handednessQuestions: document.getElementById('handedness-questions'),
            // Error messages
            demographicsError: document.getElementById('demographics-error'),
            handednessError: document.getElementById('handedness-error'),
            consentError: document.getElementById('consent-error')
        };

        // ============================================================
        // UTILITY FUNCTIONS
        // ============================================================
        function showStep(stepElement) {
            document.querySelectorAll('.container').forEach(el => el.classList.add('hidden'));
            stepElement.classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function showError(errorElement, message) {
            errorElement.textContent = message;
            errorElement.classList.add('visible');
        }

        function hideError(errorElement) {
            errorElement.classList.remove('visible');
        }

        function validateDemographics() {
            const prolificId = elements.prolificId.value.trim();
            const inputDevice = elements.inputDevice.value;
            const playedBefore = elements.playedBefore.value;
            const age = elements.age.value;
            const gender = elements.gender.value;
            
            if (!prolificId || !inputDevice || !playedBefore || !age || !gender) {
                showError(elements.demographicsError, 'Please answer all questions before continuing.');
                return false;
            }
            
            if (parseInt(age) < 18) {
                showError(elements.demographicsError, 'You must be 18 or older to participate.');
                return false;
            }
            
            // Store values
            state.demographics = { prolificId, inputDevice, playedBefore, age: parseInt(age), gender };
            hideError(elements.demographicsError);
            return true;
        }
        
        function checkDeviceEligibility() {
            const { allowedDevices } = CONFIG.inputDevice;
            const device = state.demographics.inputDevice;
            
            if (!allowedDevices.includes(device)) {
                state.eligibility = {
                    isEligible: false,
                    dominantHand: null,
                    reason: `This study requires a mouse. You selected: ${device}`
                };
                return false;
            }
            return true;
        }

        function validateHandedness() {
            // Check all questions are answered
            for (const q of HANDEDNESS_QUESTIONS) {
                if (!state.handedness[q.id]) {
                    showError(elements.handednessError, 'Please answer all handedness questions.');
                    return false;
                }
            }
            
            hideError(elements.handednessError);
            return true;
        }

        function determineEligibility() {
            const { recruitingFor, criticalQuestionsLeft, criticalQuestionsRight } = CONFIG.handedness;
            
            // Select which critical questions to use based on recruitment mode
            let criticalQuestions;
            if (recruitingFor === 'left') {
                criticalQuestions = criticalQuestionsLeft;
            } else if (recruitingFor === 'right') {
                criticalQuestions = criticalQuestionsRight;
            } else {
                // 'both' mode - use the smaller subset
                criticalQuestions = criticalQuestionsLeft;
            }
            
            // Get answers for critical questions
            const criticalAnswers = criticalQuestions.map(q => state.handedness[q]);
            
            // Check if all critical answers are the same
            const allSame = criticalAnswers.every(a => a === criticalAnswers[0]);
            
            if (!allSame) {
                state.eligibility = {
                    isEligible: false,
                    dominantHand: 'mixed',
                    reason: 'Mixed handedness on critical tasks'
                };
                return false;
            }
            
            const dominantHand = criticalAnswers[0]; // 'left' or 'right'
            
            // Check if matches recruitment criteria
            if (recruitingFor === 'both') {
                state.eligibility = {
                    isEligible: true,
                    dominantHand,
                    reason: 'Meets criteria'
                };
                return true;
            }
            
            if (dominantHand === recruitingFor) {
                state.eligibility = {
                    isEligible: true,
                    dominantHand,
                    reason: 'Meets criteria'
                };
                return true;
            }
            
            state.eligibility = {
                isEligible: false,
                dominantHand,
                reason: `Study is currently recruiting ${recruitingFor}-handed participants only`
            };
            return false;
        }

        function validateConsent() {
            const ageChecked = elements.checkboxAge.checked;
            const readChecked = elements.checkboxRead.checked;
            const consentChecked = elements.checkboxConsent.checked;
            
            if (!ageChecked || !readChecked || !consentChecked) {
                showError(elements.consentError, 'Please check all boxes to continue.');
                return false;
            }
            
            hideError(elements.consentError);
            return true;
        }

        // ============================================================
        // BUILD HANDEDNESS QUESTIONNAIRE
        // ============================================================
        function buildHandednessForm() {
            const container = elements.handednessQuestions;
            container.innerHTML = '';
            
            HANDEDNESS_QUESTIONS.forEach(q => {
                const item = document.createElement('div');
                item.className = 'handedness-item';
                item.innerHTML = `
                    <label>${q.label}</label>
                    <div class="handedness-options">
                        <label>
                            <input type="radio" name="hand-${q.id}" value="left">
                            Left
                        </label>
                        <label>
                            <input type="radio" name="hand-${q.id}" value="right">
                            Right
                        </label>
                    </div>
                `;
                
                // Add event listeners
                item.querySelectorAll('input[type="radio"]').forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        state.handedness[q.id] = e.target.value;
                    });
                });
                
                container.appendChild(item);
            });
        }

        // ============================================================
        // EVENT HANDLERS
        // ============================================================
        function setupEventListeners() {
            // Demographics -> Handedness (or rejection if wrong device)
            elements.btnToHandedness.addEventListener('click', async () => {
                if (!validateDemographics()) return;
                
                // Check device eligibility first
                if (!checkDeviceEligibility()) {
                    await recordStatistics();
                    showStep(elements.stepRejectedDevice);
                    return;
                }
                
                showStep(elements.stepHandedness);
            });
            
            // Handedness -> Consent (or Rejection)
            elements.btnToConsent.addEventListener('click', async () => {
                if (!validateHandedness()) return;
                
                const isEligible = determineEligibility();
                
                // Record statistics
                await recordStatistics();
                
                if (isEligible) {
                    // Upload participant data
                    await uploadParticipantData();
                    showStep(elements.stepConsent);
                } else {
                    // Show rejection screen
                    showStep(elements.stepRejected);
                }
            });
            
            // Back buttons
            elements.btnBackToDemographics.addEventListener('click', () => {
                showStep(elements.stepDemographics);
            });
            
            elements.btnBackToHandedness.addEventListener('click', () => {
                showStep(elements.stepHandedness);
            });
            
            // Consent -> Instructions
            elements.btnStartGame.addEventListener('click', () => {
                if (validateConsent()) {
                    const handSpan = document.getElementById('instruction-hand');
                    handSpan.textContent = CONFIG.handedness.hand_to_use;
                    showStep(elements.stepInstructions);
                }
            });
            
            // Instructions -> Game
            elements.btnBegin.addEventListener('click', () => {
                localStorage.setItem('prolificId', state.demographics.prolificId);
                localStorage.setItem('hand_to_use', CONFIG.handedness.hand_to_use);
                localStorage.setItem('collection_name', CONFIG.firebase.experimentCollection)
                sessionStorage.setItem('gameStarted', 'true');
                localStorage.setItem('fullscreenIntent', 'true');
                window.location.href = CONFIG.navigation.gamePage;
            });
        }

        // ============================================================
        // FIREBASE OPERATIONS
        // ============================================================
        async function uploadParticipantData() {
            if (!CONFIG.firebase.enabled || !firebaseRefs.auth?.currentUser) {
                console.log('Firebase upload disabled or not authenticated');
                return;
            }
            
            try {
                const { db, auth, doc, setDoc, Timestamp } = firebaseRefs;
                const oderId = `${state.demographics.prolificId}_${auth.currentUser.uid}`;
                
                // Create participant document
                const participantRef = doc(db, CONFIG.firebase.experimentCollection, oderId);
                
                await setDoc(participantRef, {
                    oderId,
                    visitorUid: auth.currentUser.uid,
                    demographics: state.demographics,
                    handednessResponses: state.handedness,
                    eligibility: state.eligibility,
                    experimentCondition: {
                        assignedHand: CONFIG.handedness.hand_to_use, // 'RIGHT' or 'LEFT'
                        recruitmentTarget: CONFIG.handedness.recruitingFor, // 'right', 'left', or 'both'
                        rotation_direction: CONFIG.handedness.direction // 'CW' or 'CCW'
                    },
                    createdAt: Timestamp.fromDate(new Date())
                }, { merge: true });
                
                console.log('Participant data uploaded successfully');
            } catch (error) {
                console.error('Error uploading participant data:', error);
            }
        }

        async function recordStatistics() {
            if (!CONFIG.firebase.enabled || !firebaseRefs.auth?.currentUser) {
                console.log('Firebase upload disabled or not authenticated');
                return;
            }
            
            try {
                const { db, doc, setDoc, getDoc, Timestamp, increment } = firebaseRefs;
                const statsRef = doc(db, CONFIG.firebase.experimentCollection, CONFIG.firebase.statisticsDocument);
                
                // Get current stats or create new
                const statsSnap = await getDoc(statsRef);
                const currentStats = statsSnap.exists() ? statsSnap.data() : {
                    totalSubmissions: 0,
                    eligibleCount: 0,
                    rejectedCount: 0,
                    byHandedness: {
                        left: { total: 0, eligible: 0, rejected: 0 },
                        right: { total: 0, eligible: 0, rejected: 0 },
                        mixed: { total: 0, eligible: 0, rejected: 0 }
                    },
                    byInputDevice: {
                        mouse: 0,
                        trackpad: 0,
                        other: 0
                    },
                    rejectionReasons: {},
                    submissions: []
                };
                
                // Update stats
                currentStats.totalSubmissions++;
                
                const hand = state.eligibility.dominantHand || 'mixed';
                const device = state.demographics.inputDevice;
                
                // Initialize if needed
                if (!currentStats.byHandedness[hand]) {
                    currentStats.byHandedness[hand] = { total: 0, eligible: 0, rejected: 0 };
                }
                if (!currentStats.byInputDevice[device]) {
                    currentStats.byInputDevice[device] = 0;
                }
                
                currentStats.byHandedness[hand].total++;
                currentStats.byInputDevice[device]++;
                
                if (state.eligibility.isEligible) {
                    currentStats.eligibleCount++;
                    currentStats.byHandedness[hand].eligible++;
                } else {
                    currentStats.rejectedCount++;
                    currentStats.byHandedness[hand].rejected++;
                    
                    // Track rejection reasons
                    const reason = state.eligibility.reason;
                    currentStats.rejectionReasons[reason] = (currentStats.rejectionReasons[reason] || 0) + 1;
                }
                
                // Add submission record (keep last 1000)
                currentStats.submissions.push({
                    prolificId: state.demographics.prolificId,
                    timestamp: new Date().toISOString(),
                    dominantHand: hand,
                    inputDevice: device,
                    eligible: state.eligibility.isEligible,
                    reason: state.eligibility.reason
                });
                
                if (currentStats.submissions.length > 1000) {
                    currentStats.submissions = currentStats.submissions.slice(-1000);
                }
                
                currentStats.lastUpdated = Timestamp.fromDate(new Date());
                
                await setDoc(statsRef, currentStats);
                
                console.log('Statistics recorded successfully');
            } catch (error) {
                console.error('Error recording statistics:', error);
            }
        }

        // ============================================================
        // INITIALIZATION
        // ============================================================
        function initialize() {
            buildHandednessForm();
            setupEventListeners();
        }

        // Run initialization
        initialize();
    </script>

    <!-- ============================================================
         FIREBASE MODULE
         ============================================================ -->
    <script type="module">
        import { initializeFirebase } from './firebaseConfig.js';
        import { doc, setDoc, getDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { signInAnonymously } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

        const { db, auth } = initializeFirebase();
        
        // Store Firebase references
        firebaseRefs.db = db;
        firebaseRefs.auth = auth;
        firebaseRefs.doc = doc;
        firebaseRefs.setDoc = setDoc;
        firebaseRefs.getDoc = getDoc;
        firebaseRefs.Timestamp = Timestamp;
        
        // Sign in anonymously
        signInAnonymously(auth)
            .then(() => {
                console.log('Signed in anonymously');
            })
            .catch((error) => {
                console.error('Auth error:', error);
            });
    </script>
</body>
</html>